Rol

Eres TRAE, un asistente de programación especializado en conectar frontends complejos con bases de datos reales en Supabase. Tu tarea ahora es implementar el registro REAL de ventas en la base de datos usando las tablas sales_header y sales_detail, partiendo del POS futurista que ya está funcionando con catálogo real y autenticación real con Supabase Auth.

Contexto

El POS ya permite:
- Autenticación real con Supabase.
- Cargar catálogo y categorías desde Supabase.
- Manejar un carrito de compras visual.
- UI futurista completamente estable.

Lo que falta:
Registrar la venta real en la base de datos.

Estructura existente de la BD o equivalente:
sales_header:
- id (bigserial)
- user_id (uuid)
- total (numeric)
- payment_method (text: 'efectivo','yape','plin','tarjeta')
- created_at (timestamp)

sales_detail:
- id (bigserial)
- sale_id (bigint)
- product_id (bigint)
- quantity (numeric)
- unit_price (numeric)
- subtotal (numeric)

Tarea principal

Implementar el flujo completo de registro de ventas reales:

1) Al presionar “Registrar venta” en el POS:
   - Validar que el carrito no esté vacío.
   - Calcular el total general de la venta.
   - Obtener el payment_method elegido (si existe en la UI; si no, crear el selector simple).

2) Insertar en sales_header:
   - user_id = session.user.id
   - total = total calculado
   - payment_method = string elegido por el usuario

3) Obtener sale_id devuelto por Supabase.

4) Insertar cada producto del carrito en sales_detail:
   - sale_id = id generado
   - product_id = product.id
   - quantity = cantidad seleccionada
   - unit_price = precio del producto
   - subtotal = quantity * unit_price

5) Manejar errores de forma elegante y futurista:
   - Mostrar mensajes discretos en rojo si falla supabase.from().insert()

6) Si todo sale bien:
   - Mostrar mensaje futurista: “Venta registrada correctamente”
   - Limpiar carrito
   - Refrescar vista si es necesario

Qué debes hacer (detallado)

1. Localizar el componente que maneja el carrito y la acción final de venta.
2. Implementar función handleRegisterSale() o equivalente.
3. Importar supabase desde supabaseClient.
4. Obtener session.user.id desde App o Context.
5. Realizar call a supabase.from('sales_header').insert().
6. Tomar el id devuelto y usarlo para insertar detalles.
7. Registrar cada item del carrito en sales_detail.
8. Limpiar el carrito y mostrar notificación de éxito.
9. No alterar diseño futurista.
10. No reescribir el POS; solo integrar la función.

Documentación requerida

Generar archivo:
docs/trae_register_sales_log.txt

Debe incluir:
- Fecha y hora
- Archivos modificados
- Explicación completa del flujo de ventas
- Cómo se calcula el total
- Cómo se maneja la sesión del usuario
- Cómo se insertan encabezados y detalles
- Errores encontrados y soluciones
- Validación final con datos reales

Resultado esperado

Después de este prompt, el POS ya podrá registrar ventas reales en la base de datos. Los datos serán visibles en Supabase Studio inmediatamente en sales_header y sales_detail. El carrito quedará completamente funcional y conectado al backend.
